{"version":3,"sources":["../../../../src/components/widgets/text_editors/MultiFormat.js"],"names":["MultiFormatTextEditor","props","context","_","localize","editors","key","label","component","RichTextEditor","LaTeXEditor","HTMLEditor","startTab","value","state","nextTab","currentTab","messages","onModeChange","bind","editor","defaultValuePattern","onChange","trimmedValue","trim","trimmedValueLength","length","convertedValue","convertValue","isDefaultValue","test","switchingBetweenRichAndHtml","setState","render","onCancel","onContinue","placeholder","richTextClassNames","selected","latexClassNames","bottomTabClassNames","Editor","filter","ModeTabsText","map","showBottomTab","BottomTab","toLowerCase","content","renderConfirmationPanel","renderEditor","Component","propTypes","PropTypes","instanceOf","RegExp","func","isRequired","string","defaultProps","contextType","EditorControlsContext"],"mappings":"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","file":"MultiFormat.js","sourcesContent":["import HTMLEditor from './HTML';\nimport LaTeXEditor from './LaTeX';\nimport React, {Component} from 'react';\nimport PropTypes from 'prop-types';\nimport RichTextEditor from './RichText';\nimport {isLaTeXExpr, htmlToLaTeX, laTeXToHTML, hasTextExpression} from './convertFormats';\nimport classnames from 'classnames';\nimport Button from 'components/widgets/Button';\nimport {EditorControlsContext} from '../../../context';\n\nclass MultiFormatTextEditor extends Component {\n  constructor(props, context) {\n    super(props, context);\n\n    const _ = context.localize;\n\n    const editors = [\n      {\n        key: 'RICH_TEXT',\n        label: _('Rich Text'),\n        component: RichTextEditor,\n      },\n      {\n        key: 'LATEX',\n        label: _('LaTeX'),\n        component: LaTeXEditor,\n      },\n      {\n        key: 'HTML',\n        label: _('Edit in HTML'),\n        component: HTMLEditor,\n      },\n    ];\n\n    const startTab = isLaTeXExpr(props.value) ? 'LATEX' : 'RICH_TEXT';\n\n    this.state = {\n      /*\n       * When nextTab is set, we are waiting for confirmation from the\n       * user before switching to the next tab.\n       */\n      nextTab: null,\n      currentTab: startTab,\n      messages: [],\n    };\n\n    this.onModeChange = this.onModeChange.bind(this);\n    this.editors = editors;\n  }\n\n  /**\n   * Convert a value to the format expected by the provided editor.\n   *\n   * @param {String} value The current value\n   * @param {String} editor The editor to convert for [RICH_TEXT|LATEX]\n   * @returns {String} The converted value\n   */\n  convertValue(value, editor) {\n    const {currentTab} = this.state;\n\n    if (currentTab === 'RICH_TEXT' && editor === 'LATEX') {\n      return htmlToLaTeX(value);\n    }\n\n    if (currentTab === 'LATEX' && editor === 'RICH_TEXT') {\n      return laTeXToHTML(value);\n    }\n\n    if (currentTab === 'HTML' && editor === 'LATEX') {\n      return htmlToLaTeX(value);\n    }\n\n    /*\n     * Else we're switching from / to HTML / Rich Text Editor\n     * no conversion is needed\n     */\n    return value;\n  }\n\n  onModeChange(nextTab) {\n    const {localize: _} = this.context;\n    const {defaultValuePattern, value, onChange} = this.props;\n    const {currentTab} = this.state;\n    const trimmedValue = value.trim();\n    const trimmedValueLength = trimmedValue.length;\n    const convertedValue = this.convertValue(trimmedValue, nextTab);\n\n    /*\n     * Check against default value - we have to compare the plain\n     * value, not the LaTeX format value with `\\text{}` wrapping.\n     */\n    const isDefaultValue = isLaTeXExpr(trimmedValue)\n      ? defaultValuePattern.test(convertedValue)\n      : defaultValuePattern.test(trimmedValue);\n\n    const switchingBetweenRichAndHtml =\n      (currentTab === 'RICH_TEXT' && nextTab === 'HTML') ||\n      (currentTab === 'HTML' && nextTab === 'RICH_TEXT');\n\n    if (!isDefaultValue && trimmedValueLength > 0 && !switchingBetweenRichAndHtml) {\n      // Show confirmation dialogue and defer tab change.\n      let messages;\n\n      if (!isLaTeXExpr(value)) {\n        messages = [\n          _(\"LaTeX is a math typesetting language that doesn't work with rich text.\"),\n          _('Continuing will convert your note to LaTeX-style text.'),\n        ];\n      } else if (hasTextExpression(value)) {\n        messages = [\n          _('Rich text is incompatible with LaTeX.'),\n          _('Continuing will convert your LaTeX expression into raw text.'),\n        ];\n      } else {\n        messages = [\n          _('Rich text is incompatible with LaTeX.'),\n          _('Continuing will remove your expression.'),\n        ];\n      }\n\n      this.setState({\n        nextTab,\n        messages,\n      });\n\n      return;\n    }\n\n    // Show requested tab immediately.\n    this.setState({\n      currentTab: nextTab,\n    });\n\n    // Convert the annotation and dispatch onChange action\n    onChange(convertedValue);\n  }\n\n  renderConfirmationPanel(render) {\n    if (!render) {\n      return null;\n    }\n\n    const {localize: _} = this.context;\n    const {messages} = this.state;\n\n    const onCancel = () => {\n      this.setState({\n        nextTab: null,\n      });\n    };\n\n    const onContinue = () => {\n      const {nextTab} = this.state;\n      const {onChange, value} = this.props;\n\n      // Set next tab as active\n      this.setState({\n        currentTab: nextTab,\n        nextTab: null,\n      });\n\n      // Convert the annotation\n      const convertedValue = this.convertValue(value, nextTab);\n      onChange(convertedValue);\n    };\n\n    return (\n      <div className=\"multi-format-editor__confirmation-panel\">\n        <div className=\"multi-format-editor__confirmation-panel__content\">\n          <h3 className=\"multi-format-editor__confirmation-panel__header\">{_('Heads up!')}</h3>\n          <div className=\"multi-format-editor__confirmation-panel__message\">\n            <p className=\"multi-format-editor__confirmation-panel__message-primary\">\n              {messages[0]}\n            </p>\n            <p className=\"multi-format-editor__confirmation-panel__message-secondary\">\n              {messages[1]}\n            </p>\n          </div>\n        </div>\n        <div className=\"multi-format-editor__confirmation-panel__actions\">\n          <Button\n            variant=\"default\"\n            className=\"multi-format-editor__confirmation-panel__cancel-button\"\n            onClick={onCancel}\n          >\n            {_('Go back')}\n          </Button>\n          <Button\n            variant=\"primary\"\n            className=\"multi-format-editor__confirmation-panel__continue-button\"\n            onClick={onContinue}\n          >\n            {_('Continue')}\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  renderEditor(render) {\n    if (!render) {\n      return null;\n    }\n    const {localize: _} = this.context;\n    const {onChange, placeholder, value} = this.props;\n\n    const {currentTab} = this.state;\n\n    const richTextClassNames = classnames('multi-format-editor__tab', 'top-tab', 'left', {\n      selected: currentTab === 'RICH_TEXT',\n    });\n    const latexClassNames = classnames('multi-format-editor__tab', 'top-tab', 'right', {\n      selected: currentTab === 'LATEX',\n    });\n    const bottomTabClassNames = classnames('multi-format-editor__tab', 'bottom-tab');\n\n    const Editor = this.editors.filter(editor => editor.key === currentTab)[0].component;\n\n    const ModeTabsText = this.editors.map(editor => editor.label);\n\n    const showBottomTab = currentTab === 'HTML' || currentTab === 'RICH_TEXT';\n    const BottomTab =\n      currentTab === 'HTML' ? (\n        <div className={bottomTabClassNames} onClick={() => this.onModeChange('RICH_TEXT')}>\n          {_('Edit in Rich Text')}\n        </div>\n      ) : (\n        <div className={bottomTabClassNames} onClick={() => this.onModeChange('HTML')}>\n          {_('Edit in HTML')}\n        </div>\n      );\n\n    return (\n      <div className=\"multi-format-editor__root__wrapper\">\n        <div className=\"multi-format-editor__tabs\">\n          <div className={richTextClassNames} onClick={() => this.onModeChange('RICH_TEXT')}>\n            {ModeTabsText[0]}\n          </div>\n          <div className={latexClassNames} onClick={() => this.onModeChange('LATEX')}>\n            {ModeTabsText[1]}\n          </div>\n        </div>\n        <div className={`multi-format-editor__content__wrapper__${currentTab.toLowerCase()}`}>\n          <Editor\n            className={`multi-format-editor__${currentTab.toLowerCase()}`}\n            onChange={onChange}\n            placeholder={placeholder}\n            value={value}\n          />\n        </div>\n        {showBottomTab ? BottomTab : null}\n      </div>\n    );\n  }\n\n  render() {\n    /*\n     * `renderConfirmationPanel` and `renderEditor` are mutually\n     * exclusive; only one will return a component.\n     */\n    const {nextTab} = this.state;\n    const content =\n      this.renderConfirmationPanel(nextTab !== null) || this.renderEditor(nextTab === null);\n\n    return <div className=\"multi-format-editor__root\">{content}</div>;\n  }\n}\n\nMultiFormatTextEditor.propTypes = {\n  defaultValuePattern: PropTypes.instanceOf(RegExp),\n  onChange: PropTypes.func.isRequired,\n  placeholder: PropTypes.string,\n  value: PropTypes.string,\n};\n\nMultiFormatTextEditor.defaultProps = {\n  defaultValuePattern: /^$/,\n  placeholder: '',\n  value: '',\n};\n\nMultiFormatTextEditor.contextType = EditorControlsContext;\n\nexport default MultiFormatTextEditor;\n"]}